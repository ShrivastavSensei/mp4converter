#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
VERSION="1.0.0"
QUALITY=0
OUTDIR=""
TARGET="."

#######################################
# PATHS
#######################################
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ASCII_FILE="$SCRIPT_DIR/ascii.txt"

#######################################
# UI
#######################################
show_banner() {
  if [[ -f "$ASCII_FILE" ]]; then
    cat "$ASCII_FILE"
    echo
  fi
}

usage() {
  show_banner
  echo "mp4convert v$VERSION"
  echo
  echo "Usage:"
  echo "  mp4convert [options] <file|directory>"
  echo
  echo "Options:"
  echo "  -q <0-9>    MP3 quality (0=best, 9=worst). Default: 0"
  echo "  -o <dir>    Output directory (default: same as source)"
  echo "  -h          Show help"
  echo "  --version   Show version"
  exit 0
}

#######################################
# VERSION FLAG (early exit)
#######################################
if [[ "${1:-}" == "--version" ]]; then
  show_banner
  echo "mp4convert v$VERSION"
  exit 0
fi

#######################################
# ARG PARSING
#######################################
while getopts "q:o:h" opt; do
  case "$opt" in
    q) QUALITY="$OPTARG" ;;
    o) OUTDIR="$OPTARG" ;;
    h) usage ;;
    *) usage ;;
  esac
done
shift "$((OPTIND - 1))"

if [[ $# -eq 1 ]]; then
  TARGET="$1"
elif [[ $# -gt 1 ]]; then
  echo "Error: too many arguments"
  exit 1
fi

#######################################
# VALIDATION
#######################################
command -v ffmpeg >/dev/null || {
  echo "Error: ffmpeg not installed"
  exit 1
}

[[ "$QUALITY" =~ ^[0-9]$ ]] || {
  echo "Error: quality must be 0–9"
  exit 1
}

#######################################
# CORE LOGIC
#######################################
process_file() {
  local f="$1"
  local out="${f%.mp4}.mp3"

  if [[ -n "$OUTDIR" ]]; then
    mkdir -p "$OUTDIR"
    out="$OUTDIR/$(basename "$out")"
  fi

  echo "▶ Converting:"
  echo "  $f"

  ffmpeg -loglevel error -stats \
    -i "$f" -vn -map_metadata 0 -q:a "$QUALITY" "$out"
}

#######################################
# EXECUTION
#######################################
show_banner

if [[ -f "$TARGET" ]]; then
  process_file "$TARGET"

elif [[ -d "$TARGET" ]]; then
  find "$TARGET" -type f -iname "*.mp4" -print0 |
  while IFS= read -r -d '' f; do
    process_file "$f"
  done
else
  echo "Invalid path: $TARGET"
  exit 1
fi

echo
echo "✔ Done."
